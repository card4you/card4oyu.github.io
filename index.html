<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokéTracker Pro - Base de Datos Persistente</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --accent: #bb86fc;
            --text: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        /* Panel de Control */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #333;
            background: #2c2c2c;
            color: white;
        }

        button {
            padding: 10px 20px;
            background: var(--accent);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: #000;
        }

        button:hover { filter: brightness(1.1); }

        /* Grid de Cartas */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .card-container {
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #333;
            transition: transform 0.2s;
        }

        .card-container:hover { transform: translateY(-5px); border-color: var(--accent); }

        .card-img {
            width: 100%;
            height: auto;
            display: block;
        }

        .card-info {
            padding: 10px;
        }

        .card-title {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #aaa;
        }

        .card-name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* Variantes (Checkboxes) */
        .variants {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .variant-tag {
            font-size: 0.8em;
            background: #333;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
        }

        .variant-tag.active {
            background: var(--accent);
            color: #000;
            font-weight: bold;
        }

        /* Loading */
        #loading { display: none; text-align: center; margin: 20px; }
        
        .stats { font-size: 0.8rem; margin-top: 5px; color: #888; }
    </style>
</head>
<body>

    <div class="controls">
        <input type="text" id="searchInput" placeholder="Buscar carta (Ej: Pikachu, Charizard, Energy, Trainer)...">
        <button onclick="searchCards()">Buscar</button>
        <div id="collectionStats" style="margin-left: auto; align-self: center;">Colección: 0 cartas</div>
    </div>

    <div id="loading">Cargando datos de la API...</div>
    <div class="grid" id="cardGrid"></div>

<script>
    // --- LÓGICA DEL SISTEMA ---

    // 1. Base de datos local (Tu colección guardada)
    // Estructura: { "card_id": ["normal", "holo"] }
    let myCollection = JSON.parse(localStorage.getItem('pokeCollection')) || {};

    const apiBase = "https://api.pokemontcg.io/v2/cards";
    // NOTA: Sin API Key tienes un límite de peticiones. Para uso intensivo, consigue una gratis en pokemontcg.io

    // Variantes posibles para marcar
    const variants = [
        { id: 'normal', label: 'Normal' },
        { id: 'holo', label: 'Holo' },
        { id: 'reverse', label: 'Reverse' },
        { id: 'masterball', label: 'Master Ball' }, // Para set 151
        { id: 'first_ed', label: '1ª Ed.' }
    ];

    // 2. Función de búsqueda en la API
    async function searchCards() {
        const query = document.getElementById('searchInput').value;
        const grid = document.getElementById('cardGrid');
        const loader = document.getElementById('loading');

        if (!query) return;

        grid.innerHTML = '';
        loader.style.display = 'block';

        try {
            // Buscamos por nombre. Se puede ampliar a 'set.id', 'types', etc.
            const response = await fetch(`${apiBase}?q=name:"${query}*"&pageSize=20`);
            const data = await response.json();
            
            loader.style.display = 'none';
            renderCards(data.data);
        } catch (error) {
            console.error(error);
            loader.innerText = "Error al conectar con la API.";
        }
    }

    // 3. Renderizado de cartas
    function renderCards(cards) {
        const grid = document.getElementById('cardGrid');

        if(!cards || cards.length === 0) {
            grid.innerHTML = '<p>No se encontraron cartas.</p>';
            return;
        }

        cards.forEach(card => {
            const el = document.createElement('div');
            el.className = 'card-container';
            
            // Verificamos qué variantes ya tienes guardadas
            const savedVariants = myCollection[card.id] || [];

            // HTML de la carta
            let variantsHTML = '';
            variants.forEach(v => {
                const isActive = savedVariants.includes(v.id) ? 'active' : '';
                variantsHTML += `<div class="variant-tag ${isActive}" 
                                onclick="toggleVariant('${card.id}', '${v.id}', this)">
                                ${v.label}
                               </div>`;
            });

            el.innerHTML = `
                <img src="${card.images.small}" class="card-img" loading="lazy" alt="${card.name}">
                <div class="card-info">
                    <div class="card-title">${card.set.name} (${card.rarity || 'Common'})</div>
                    <div class="card-name">${card.name}</div>
                    <div class="variants">${variantsHTML}</div>
                </div>
            `;
            grid.appendChild(el);
        });
    }

    // 4. Lógica de Guardado (Persistencia)
    function toggleVariant(cardId, variantType, element) {
        // Inicializar array si la carta es nueva en la colección
        if (!myCollection[cardId]) {
            myCollection[cardId] = [];
        }

        const index = myCollection[cardId].indexOf(variantType);

        if (index === -1) {
            // Añadir
            myCollection[cardId].push(variantType);
            element.classList.add('active');
        } else {
            // Quitar
            myCollection[cardId].splice(index, 1);
            element.classList.remove('active');
            
            // Si no quedan variantes, borramos la key para ahorrar espacio
            if (myCollection[cardId].length === 0) {
                delete myCollection[cardId];
            }
        }

        saveToDisk();
    }

    function saveToDisk() {
        // Guardamos todo el objeto JSON en el almacenamiento del navegador
        localStorage.setItem('pokeCollection', JSON.stringify(myCollection));
        updateStats();
    }

    function updateStats() {
        const count = Object.keys(myCollection).length;
        document.getElementById('collectionStats').innerText = `Colección: ${count} cartas únicas`;
    }

    // Cargar estadísticas al inicio
    updateStats();

    // Habilitar Enter para buscar
    document.getElementById('searchInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') searchCards();
    });

</script>
</body>
</html>
